<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings | HORIZON Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="admin-style.css">
</head>
<body class="admin-body">

    <!-- Sidebar -->
    <aside class="admin-sidebar">
        <div class="sidebar-header">
            <h2>HORIZON</h2>
            <p>Admin Panel</p>
        </div>
        <nav class="sidebar-nav">
            <a href="dashboard.html" class="nav-item">
                <span class="nav-icon">üìä</span>
                <span>Dashboard</span>
            </a>
            <a href="settings.html" class="nav-item active">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span>Settings</span>
            </a>
            <a href="#" class="nav-item" onclick="logout()">
                <span class="nav-icon">üö™</span>
                <span>Logout</span>
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
        <div class="admin-header">
            <h1>Account Settings</h1>
        </div>

        <div class="settings-container">
            <!-- Account Info -->
            <div class="settings-card">
                <h2>Account Information</h2>
                <form id="accountForm">
                    <div class="form-group">
                        <label for="username">Username *</label>
                        <input type="text" id="username" required>
                    </div>

                    <div class="form-group">
                        <label for="email">Email Address *</label>
                        <input type="email" id="email" required>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>

            <!-- Change Password -->
            <div class="settings-card">
                <h2>Change Password</h2>
                <form id="passwordForm">
                    <div class="form-group">
                        <label for="currentPassword">Current Password *</label>
                        <input type="password" id="currentPassword" required>
                    </div>

                    <div class="form-group">
                        <label for="newPassword">New Password *</label>
                        <input type="password" id="newPassword" required minlength="6">
                        <small style="color: var(--admin-text-muted);">Minimum 6 characters</small>
                    </div>

                    <div class="form-group">
                        <label for="confirmPassword">Confirm New Password *</label>
                        <input type="password" id="confirmPassword" required>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn-primary">Update Password</button>
                    </div>
                </form>
            </div>

            <!-- Danger Zone -->
            <div class="settings-card" style="border-color: var(--admin-danger);">
                <h2 style="color: var(--admin-danger);">Danger Zone</h2>
                <p style="color: var(--admin-text-muted); margin-bottom: 20px;">
                    These actions are irreversible. Please be certain before proceeding.
                </p>
                <button class="btn-danger" onclick="clearAllData()">Clear All Property Data</button>
            </div>
        </div>
    </main>

    <script>
        const API_URL = 'http://localhost:3000/api';

        // Check authentication
        function checkAuth() {
            const admin = sessionStorage.getItem('admin');
            if (!admin) {
                window.location.href = 'login.html';
            }
        }

        // Logout
        function logout() {
            sessionStorage.removeItem('admin');
            window.location.href = 'login.html';
        }

        // Load current settings
        async function loadSettings() {
            try {
                const response = await fetch(`${API_URL}/admin/settings`);
                const data = await response.json();

                document.getElementById('username').value = data.username;
                document.getElementById('email').value = data.email;
            } catch (error) {
                console.error('Error loading settings:', error);
                showAlert('Failed to load settings', 'error');
            }
        }

        // Update account info
        document.getElementById('accountForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;

            try {
                const response = await fetch(`${API_URL}/admin/settings`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email })
                });

                if (response.ok) {
                    const data = await response.json();
                    sessionStorage.setItem('admin', JSON.stringify(data.user));
                    showAlert('Account updated successfully', 'success');
                } else {
                    throw new Error('Failed to update');
                }
            } catch (error) {
                console.error('Error updating account:', error);
                showAlert('Failed to update account', 'error');
            }
        });

        // Change password
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                showAlert('Passwords do not match', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showAlert('Password must be at least 6 characters', 'error');
                return;
            }

            try {
                // First verify current password by attempting login
                const loginResponse = await fetch(`${API_URL}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: document.getElementById('username').value,
                        password: currentPassword
                    })
                });

                if (!loginResponse.ok) {
                    showAlert('Current password is incorrect', 'error');
                    return;
                }

                // Update password
                const response = await fetch(`${API_URL}/admin/settings`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: newPassword })
                });

                if (response.ok) {
                    showAlert('Password updated successfully', 'success');
                    document.getElementById('passwordForm').reset();
                } else {
                    throw new Error('Failed to update password');
                }
            } catch (error) {
                console.error('Error updating password:', error);
                showAlert('Failed to update password', 'error');
            }
        });

        // Clear all data
        async function clearAllData() {
            if (!confirm('Are you absolutely sure? This will delete ALL properties. This action cannot be undone.')) {
                return;
            }

            if (!confirm('Last chance! Type "DELETE" to confirm (this is case-sensitive):\n\n(Click OK to type)')) {
                return;
            }

            const confirmation = prompt('Type DELETE to confirm:');
            if (confirmation !== 'DELETE') {
                showAlert('Incorrect confirmation', 'error');
                return;
            }

            try {
                // Get all properties
                const response = await fetch(`${API_URL}/properties`);
                const properties = await response.json();

                // Delete each property
                for (const property of properties) {
                    await fetch(`${API_URL}/properties/${property.id}`, {
                        method: 'DELETE'
                    });
                }

                showAlert('All property data cleared', 'success');
            } catch (error) {
                console.error('Error clearing data:', error);
                showAlert('Failed to clear data', 'error');
            }
        }

        // Show alert
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '10001';
            alertDiv.style.minWidth = '300px';

            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }

        // Initialize
        checkAuth();
        loadSettings();
    </script>
</body>
</html>
